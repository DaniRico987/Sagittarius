<div class="main-container">
  <!-- Sidebar -->
  <div class="sidebar" [class.hidden-mobile]="!showSidebar">
    <div class="sidebar-header">
      <div class="logo-title">
        <img src="assets/logo-removebg-preview.png" alt="Logo" class="sidebar-logo" />
        <h3>Chats</h3>
      </div>
      <div class="actions">
        <button mat-icon-button (click)="toggleFriends()" matTooltip="Amigos">
          <mat-icon>people</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="openCreateGroupDialog()"
          matTooltip="Nuevo Grupo"
        >
          <mat-icon>group_add</mat-icon>
        </button>
      </div>
    </div>

    <mat-list class="conversation-list">
      <mat-list-item
        *ngFor="let conv of conversations"
        (click)="selectConversation(conv)"
        [class.active]="selectedConversation?._id === conv._id"
      >
        <mat-icon matListItemIcon>{{
          conv.isGroup ? "group" : "person"
        }}</mat-icon>
        <div matListItemTitle>{{ getConversationName(conv) }}</div>
        <div matListItemLine class="last-msg" *ngIf="conv.lastMessage">
          {{ conv.lastMessage.content | slice : 0 : 20 }}...
        </div>
      </mat-list-item>
    </mat-list>

    <div class="sidebar-footer">
      <button
        mat-icon-button
        (click)="toggleTheme()"
        [matTooltip]="themeService.isDarkMode() ? 'Modo Claro' : 'Modo Oscuro'"
      >
        <mat-icon>{{
          themeService.isDarkMode() ? "light_mode" : "dark_mode"
        }}</mat-icon>
      </button>
      <button mat-icon-button (click)="logout()" matTooltip="Cerrar Sesión">
        <mat-icon>logout</mat-icon>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-area" [class.hidden-mobile]="showSidebar">
    <!-- Friends View -->
    <div *ngIf="showFriends" class="friends-wrapper">
      <div class="mobile-header" *ngIf="isMobile">
        <button mat-icon-button (click)="backToList()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <span>Amigos</span>
      </div>
      <app-friends></app-friends>
    </div>

    <!-- Chat View -->
    <mat-card class="chat-card" *ngIf="selectedConversation && !showFriends">
      <mat-card-header class="chat-header">
        <button mat-icon-button (click)="backToList()" *ngIf="isMobile">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-card-title>
          <mat-icon>{{
            selectedConversation.isGroup ? "group" : "person"
          }}</mat-icon>
          {{ getConversationName(selectedConversation) }}
          <span *ngIf="isOtherUserTyping" class="typing-indicator">
            <small>escribiendo...</small>
          </span>
        </mat-card-title>
      </mat-card-header>

      <div class="connection-warning" *ngIf="!isConnected">
        <mat-icon>wifi_off</mat-icon>
        <span>Sin conexión al servidor</span>
      </div>

      <mat-card-content class="chat-content">
        <div #chatContainer class="messages-container">
          <div
            *ngFor="let message of messages"
            [ngClass]="{
              sent: (message.sender_id?._id || message.sender_id) === user.id,
              received:
                (message.sender_id?._id || message.sender_id) !== user.id
            }"
            class="message-bubble"
          >
            <div
              class="sender-name"
              *ngIf="
                selectedConversation.isGroup && message.sender_id !== user.id
              "
            >
              {{ message.sender_id.name || "Usuario" }}
            </div>
            <span class="message-text">{{ message.content }}</span>
            <span class="timestamp">
              {{ message.timestamp | date : "shortTime" }}
              <!-- Message status checkmarks (only for sent messages) -->
              <span
                *ngIf="
                  (message.sender_id?._id || message.sender_id) === user.id
                "
                class="status-icon"
                [ngClass]="{
                  'status-read': message.status === 'read',
                  'status-delivered': message.status === 'delivered',
                  'status-sent': message.status === 'sent'
                }"
              >
                <mat-icon *ngIf="message.status === 'sent'">done</mat-icon>
                <mat-icon
                  *ngIf="
                    message.status === 'delivered' || message.status === 'read'
                  "
                  >done_all</mat-icon
                >
              </span>
            </span>

            <!-- Reaction button -->
            <button
              mat-icon-button
              class="reaction-button"
              (click)="toggleEmojiPicker(message._id!)"
              matTooltip="Reaccionar"
            >
              <mat-icon>add_reaction</mat-icon>
            </button>

            <!-- Emoji picker -->
            <div class="emoji-picker" *ngIf="showEmojiPicker[message._id!]">
              <button
                *ngFor="let emoji of availableEmojis"
                class="emoji-option"
                (click)="toggleReaction(message, emoji)"
                [matTooltip]="emoji"
              >
                {{ emoji }}
              </button>
            </div>

            <!-- Display reactions -->
            <div
              class="reactions-container"
              *ngIf="message.reactions && message.reactions.length > 0"
            >
              <button
                *ngFor="let emoji of availableEmojis"
                class="reaction-badge"
                [class.user-reacted]="hasUserReacted(message, emoji)"
                [class.hidden]="getReactionCount(message, emoji) === 0"
                (click)="toggleReaction(message, emoji)"
                [matTooltip]="getReactionUsers(message, emoji)"
              >
                <span class="emoji">{{ emoji }}</span>
                <span class="count">{{
                  getReactionCount(message, emoji)
                }}</span>
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions class="input-area">
        <div *ngIf="!canChat" class="blocked-message">
          No puedes enviar mensajes a este usuario porque no son amigos.
        </div>
        <mat-form-field appearance="outline" class="full-width" *ngIf="canChat">
          <mat-label>Escribe un mensaje...</mat-label>
          <textarea
            matInput
            cdkTextareaAutosize
            cdkAutosizeMinRows="1"
            cdkAutosizeMaxRows="4"
            [(ngModel)]="messageText"
            (keydown.enter)="$event.preventDefault(); sendMessage()"
            (input)="onTyping()"
            placeholder="Escribe un mensaje..."
          ></textarea>
          <button mat-icon-button matSuffix (click)="sendMessage()">
            <mat-icon>send</mat-icon>
          </button>
        </mat-form-field>
      </mat-card-actions>
    </mat-card>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!selectedConversation && !showFriends">
      <mat-icon class="large-icon">chat</mat-icon>
      <h2>Selecciona un chat o inicia una nueva conversación</h2>
    </div>
  </div>
</div>
